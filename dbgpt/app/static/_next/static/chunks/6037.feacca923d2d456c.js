"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6037],{64059:function(l,e,i){i.r(e),i.d(e,{default:function(){return E}});var a=i(85893),n=i(67294),d=i(577),t=i(45396),o=i(83062),s=i(51009),u=i(71577),v=i(79531),r=i(32983),c=i(57346),h=i(44442),x=i(99513),m=i(30119),f=i(39332),p=i(67772),g=i(39156),y=i(84477),w=i(19944),j=i(14313),_=i(87462),b={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M893.3 293.3L730.7 130.7c-12-12-28.3-18.7-45.3-18.7H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V338.5c0-17-6.7-33.2-18.7-45.2zM384 176h256v112H384V176zm128 554c-79.5 0-144-64.5-144-144s64.5-144 144-144 144 64.5 144 144-64.5 144-144 144zm0-224c-44.2 0-80 35.8-80 80s35.8 80 80 80 80-35.8 80-80-35.8-80-80-80z"}}]},name:"save",theme:"filled"},N=i(84089),S=n.forwardRef(function(l,e){return n.createElement(N.Z,(0,_.Z)({},l,{ref:e,icon:b}))});function k(){return(0,a.jsxs)("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"49817",width:"1em",height:"1em",children:[(0,a.jsx)("path",{d:"M512 64c-247.424 0-448 62.72-448 140.032v112c0 77.312 200.576 139.968 448 139.968s448-62.72 448-140.032v-112C960 126.72 759.424 64 512 64z m0 728c-247.424 0-448-62.72-448-140.032v168.064C64 897.28 264.576 960 512 960s448-62.72 448-140.032v-167.936c0 77.312-200.576 139.968-448 139.968z",fill:"#3699FF","p-id":"49818"}),(0,a.jsx)("path",{d:"M512 540.032c-247.424 0-448-62.72-448-140.032v168c0 77.312 200.576 140.032 448 140.032s448-62.72 448-140.032V400c0 77.312-200.576 140.032-448 140.032z",fill:"#3699FF",opacity:".32","p-id":"49819"})]})}function q(){return(0,a.jsxs)("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"59847",width:"1em",height:"1em",children:[(0,a.jsx)("path",{d:"M149.2 99.7h726.6c27.7 0 50.1 22.4 50.1 50.1V336H99.1V149.8c0-27.6 22.4-50.1 50.1-50.1z",fill:"#1ECD93","p-id":"59848"}),(0,a.jsx)("path",{d:"M99.1 395h236.2v236.3H99.1zM99.1 690.3h236.2v236.2H149.2c-27.7 0-50.1-22.4-50.1-50.1V690.3zM394.4 395h236.2v236.3H394.4z",fill:"#1ECD93","fill-opacity":".5","p-id":"59849"}),(0,a.jsx)("path",{d:"M394.4 690.3h236.2v236.3H394.4z",fill:"#A1E6C9","p-id":"59850","data-spm-anchor-id":"a313x.search_index.0.i13.27343a81CqKUWU"}),(0,a.jsx)("path",{d:"M689.7 395h236.2v236.3H689.7z",fill:"#1ECD93","fill-opacity":".5","p-id":"59851"}),(0,a.jsx)("path",{d:"M689.7 690.3h236.2v186.1c0 27.7-22.4 50.1-50.1 50.1H689.7V690.3z",fill:"#A1E6C9","p-id":"59852","data-spm-anchor-id":"a313x.search_index.0.i17.27343a81CqKUWU"})]})}function Z(){return(0,a.jsx)("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"67616",width:"1em",height:"1em",children:(0,a.jsx)("path",{d:"M39.385 204.83h346.571L252.054 976.74l-23.63 39.383h259.929v-31.506L614.379 204.83H771.91S960.951 220.584 984.581 0.038H236.3S94.52-7.84 39.384 204.83",fill:"#1296db","p-id":"67617"})})}let{Search:C}=v.default;function z(l){var e,i;let{editorValue:d,chartData:o,tableData:s,handleChange:u}=l,v=n.useMemo(()=>o?(0,a.jsx)("div",{className:"flex-1 overflow-auto p-3",style:{flexShrink:0,overflow:"hidden"},children:(0,a.jsx)(g.ZP,{chartsData:[o]})}):null,[o]);return(0,a.jsxs)("div",{className:"flex flex-1 h-full gap-4",children:[(0,a.jsx)("div",{className:"flex-1 flex overflow-hidden bg-white rounded",children:(0,a.jsx)(x.Z,{value:(null==d?void 0:d.sql)||"",language:"mysql",onChange:u,thoughts:(null==d?void 0:d.thoughts)||""})}),(0,a.jsxs)("div",{className:"flex-1 h-full overflow-y-auto bg-white rounded",children:[(null==s?void 0:null===(e=s.values)||void 0===e?void 0:e.length)>0?(0,a.jsx)(t.Z,{rowKey:null==s?void 0:null===(i=s.columns)||void 0===i?void 0:i[0],columns:(null==s?void 0:s.columns).map(l=>({dataIndex:l,title:l,key:l})),dataSource:null==s?void 0:s.values}):(0,a.jsx)("div",{className:"h-full flex justify-center items-center",children:(0,a.jsx)(r.Z,{})}),v]})]})}var E=function(){var l,e,i,t,v;let[r,x]=n.useState([]),[g,_]=n.useState(""),[b,N]=n.useState(),[E,M]=n.useState(!0),[D,H]=n.useState(),[P,V]=n.useState(),[A,O]=n.useState(),[R,B]=n.useState(),[K,T]=n.useState(),[F,U]=(0,n.useState)(!1),L=(0,f.useSearchParams)(),W=null==L?void 0:L.get("id"),Y=null==L?void 0:L.get("scene"),{data:$,loading:I}=(0,d.Z)(async()=>await (0,m.Tk)("/v1/editor/sql/rounds",{con_uid:W}),{onSuccess:l=>{var e,i;let a=null==l?void 0:null===(e=l.data)||void 0===e?void 0:e[(null==l?void 0:null===(i=l.data)||void 0===i?void 0:i.length)-1];a&&N(null==a?void 0:a.round)}}),{run:J,loading:G}=(0,d.Z)(async()=>{var l,e;let i=null===(l=null==$?void 0:null===(e=$.data)||void 0===e?void 0:e.find(l=>l.round===b))||void 0===l?void 0:l.db_name;return await (0,m.PR)("/api/v1/editor/sql/run",{db_name:i,sql:null==A?void 0:A.sql})},{manual:!0,onSuccess:l=>{var e,i;B({columns:null==l?void 0:null===(e=l.data)||void 0===e?void 0:e.colunms,values:null==l?void 0:null===(i=l.data)||void 0===i?void 0:i.values})}}),{run:Q,loading:X}=(0,d.Z)(async()=>{var l,e;let i=null===(l=null==$?void 0:null===(e=$.data)||void 0===e?void 0:e.find(l=>l.round===b))||void 0===l?void 0:l.db_name,a={db_name:i,sql:null==A?void 0:A.sql};return"chat_dashboard"===Y&&(a.chart_type=null==A?void 0:A.showcase),await (0,m.PR)("/api/v1/editor/chart/run",a)},{manual:!0,ready:!!(null==A?void 0:A.sql),onSuccess:l=>{if(null==l?void 0:l.success){var e,i,a,n,d,t,o;B({columns:(null==l?void 0:null===(e=l.data)||void 0===e?void 0:null===(i=e.sql_data)||void 0===i?void 0:i.colunms)||[],values:(null==l?void 0:null===(a=l.data)||void 0===a?void 0:null===(n=a.sql_data)||void 0===n?void 0:n.values)||[]}),(null==l?void 0:null===(d=l.data)||void 0===d?void 0:d.chart_values)?H({type:null==l?void 0:null===(t=l.data)||void 0===t?void 0:t.chart_type,values:null==l?void 0:null===(o=l.data)||void 0===o?void 0:o.chart_values,title:null==A?void 0:A.title,description:null==A?void 0:A.thoughts}):H(void 0)}}}),{run:ll,loading:le}=(0,d.Z)(async()=>{var l,e,i,a,n;let d=null===(l=null==$?void 0:null===(e=$.data)||void 0===e?void 0:e.find(l=>l.round===b))||void 0===l?void 0:l.db_name;return await (0,m.PR)("/api/v1/sql/editor/submit",{conv_uid:W,db_name:d,conv_round:b,old_sql:null==P?void 0:P.sql,old_speak:null==P?void 0:P.thoughts,new_sql:null==A?void 0:A.sql,new_speak:(null===(i=null==A?void 0:null===(a=A.thoughts)||void 0===a?void 0:a.match(/^\n--(.*)\n\n$/))||void 0===i?void 0:null===(n=i[1])||void 0===n?void 0:n.trim())||(null==A?void 0:A.thoughts)})},{manual:!0,onSuccess:l=>{(null==l?void 0:l.success)&&J()}}),{run:li,loading:la}=(0,d.Z)(async()=>{var l,e,i,a,n,d;let t=null===(l=null==$?void 0:null===(e=$.data)||void 0===e?void 0:e.find(l=>l.round===b))||void 0===l?void 0:l.db_name;return await (0,m.PR)("/api/v1/chart/editor/submit",{conv_uid:W,chart_title:null==A?void 0:A.title,db_name:t,old_sql:null==P?void 0:null===(i=P[K])||void 0===i?void 0:i.sql,new_chart_type:null==A?void 0:A.showcase,new_sql:null==A?void 0:A.sql,new_comment:(null===(a=null==A?void 0:null===(n=A.thoughts)||void 0===n?void 0:n.match(/^\n--(.*)\n\n$/))||void 0===a?void 0:null===(d=a[1])||void 0===d?void 0:d.trim())||(null==A?void 0:A.thoughts),gmt_create:new Date().getTime()})},{manual:!0,onSuccess:l=>{(null==l?void 0:l.success)&&Q()}}),{data:ln}=(0,d.Z)(async()=>{var l,e;let i=null===(l=null==$?void 0:null===(e=$.data)||void 0===e?void 0:e.find(l=>l.round===b))||void 0===l?void 0:l.db_name;return await (0,m.Tk)("/v1/editor/db/tables",{db_name:i,page_index:1,page_size:200})},{ready:!!(null===(l=null==$?void 0:null===(e=$.data)||void 0===e?void 0:e.find(l=>l.round===b))||void 0===l?void 0:l.db_name),refreshDeps:[null===(i=null==$?void 0:null===(t=$.data)||void 0===t?void 0:t.find(l=>l.round===b))||void 0===i?void 0:i.db_name]}),{run:ld}=(0,d.Z)(async l=>await (0,m.Tk)("/v1/editor/sql",{con_uid:W,round:l}),{manual:!0,onSuccess:l=>{let e;try{if(Array.isArray(null==l?void 0:l.data))e=null==l?void 0:l.data,T("0");else if("string"==typeof(null==l?void 0:l.data)){let i=JSON.parse(null==l?void 0:l.data);e=i}else e=null==l?void 0:l.data}catch(l){console.log(l)}finally{V(e),Array.isArray(e)?O(null==e?void 0:e[Number(K||0)]):O(e)}}}),lt=n.useMemo(()=>{let l=(e,i)=>e.map(e=>{let n=e.title,d=n.indexOf(g),t=n.substring(0,d),s=n.slice(d+g.length),u=l=>{switch(l){case"db":return(0,a.jsx)(k,{});case"table":return(0,a.jsx)(q,{});default:return(0,a.jsx)(Z,{})}},v=d>-1?(0,a.jsx)(o.Z,{title:((null==e?void 0:e.comment)||(null==e?void 0:e.title))+((null==e?void 0:e.can_null)==="YES"?"(can null)":"(can't null)"),children:(0,a.jsxs)("div",{className:"flex items-center",children:[u(e.type),"\xa0\xa0\xa0",t,(0,a.jsx)("span",{className:"text-[#1677ff]",children:g}),s,"\xa0",(null==e?void 0:e.type)&&(0,a.jsx)("div",{className:"text-gray-400",children:null==e?void 0:e.type})]})}):(0,a.jsx)(o.Z,{title:((null==e?void 0:e.comment)||(null==e?void 0:e.title))+((null==e?void 0:e.can_null)==="YES"?"(can null)":"(can't null)"),children:(0,a.jsxs)("div",{className:"flex items-center",children:[u(e.type),"\xa0\xa0\xa0",n,"\xa0",(null==e?void 0:e.type)&&(0,a.jsx)("div",{className:"text-gray-400",children:null==e?void 0:e.type})]})});if(e.children){let a=i?String(i)+"_"+e.key:e.key;return{title:n,showTitle:v,key:a,children:l(e.children,a)}}return{title:n,showTitle:v,key:e.key}});return(null==ln?void 0:ln.data)?(x([null==ln?void 0:ln.data.key]),l([null==ln?void 0:ln.data])):[]},[g,ln]),lo=n.useMemo(()=>{let l=[],e=(i,a)=>{if(i&&!((null==i?void 0:i.length)<=0))for(let n=0;n<i.length;n++){let d=i[n],{key:t,title:o}=d;l.push({key:t,title:o,parentKey:a}),d.children&&e(d.children,t)}};return lt&&e(lt),l},[lt]),ls=(l,e)=>{let i;for(let a=0;a<e.length;a++){let n=e[a];n.children&&(n.children.some(e=>e.key===l)?i=n.key:ls(l,n.children)&&(i=ls(l,n.children)))}return i};function lu(l){let e;if(!l)return{sql:"",thoughts:""};let i=l&&l.match(/(--.*)\n([\s\S]*)/),a="";return i&&i.length>=3&&(a=i[1],e=i[2]),{sql:e,thoughts:a}}return n.useEffect(()=>{b&&ld(b)},[ld,b]),n.useEffect(()=>{P&&"chat_dashboard"===Y&&K&&Q()},[K,Y,P,Q]),n.useEffect(()=>{P&&"chat_dashboard"!==Y&&J()},[Y,P,J]),(0,a.jsxs)("div",{className:"flex flex-col w-full h-full",children:[(0,a.jsx)(p.Z,{}),(0,a.jsxs)("div",{className:"relative flex flex-1",children:[(0,a.jsxs)("div",{className:"w-80 ml-4 ".concat(F&&"hidden"),children:[(0,a.jsx)(s.default,{size:"middle",className:"w-80 py-3",value:b,options:null==$?void 0:null===(v=$.data)||void 0===v?void 0:v.map(l=>({label:l.round_name,value:l.round})),onChange:l=>{N(l)}}),(0,a.jsx)(C,{style:{marginBottom:8},placeholder:"Search",onChange:l=>{let{value:e}=l.target;if(null==ln?void 0:ln.data){if(e){let l=lo.map(l=>l.title.indexOf(e)>-1?ls(l.key,lt):null).filter((l,e,i)=>l&&i.indexOf(l)===e);x(l)}else x([]);_(e),M(!0)}}}),lt&&lt.length>0&&(0,a.jsx)(c.Z,{className:"h-[782px] overflow-y-auto flex-1",onExpand:l=>{x(l),M(!1)},expandedKeys:r,autoExpandParent:E,treeData:lt,fieldNames:{title:"showTitle"}})]}),F?(0,a.jsx)(w.Z,{onClick:()=>{U(!F)},className:"w-4 cursor-pointer"}):(0,a.jsx)(y.Z,{onClick:()=>{U(!F)},className:"w-4 cursor-pointer"}),(0,a.jsxs)("div",{className:"flex flex-col flex-1 max-w-full overflow-hidden p-4",children:[(0,a.jsxs)("div",{className:"mb-4 bg-white pl-4 pt-2 pb-2",children:[(0,a.jsx)(u.ZP,{className:"mr-2",type:"primary",icon:(0,a.jsx)(j.Z,{}),loading:G||X,onClick:async()=>{"chat_dashboard"===Y?Q():J()},children:"Run"}),(0,a.jsx)(u.ZP,{type:"primary",loading:le||la,icon:(0,a.jsx)(S,{}),onClick:async()=>{"chat_dashboard"===Y?await li():await ll()},children:"Save"})]}),Array.isArray(P)?(0,a.jsx)("div",{className:"h-full",children:(0,a.jsx)(h.Z,{className:"h-full dark:text-white px-2",activeKey:K,onChange:l=>{T(l),O(null==P?void 0:P[Number(l)])},items:null==P?void 0:P.map((l,e)=>({key:e+"",label:null==l?void 0:l.title,children:(0,a.jsx)("div",{className:"flex flex-col h-[702px]",children:(0,a.jsx)(z,{editorValue:l,handleChange:l=>{let{sql:e,thoughts:i}=lu(l);O(l=>Object.assign({},l,{sql:e,thoughts:i}))},tableData:R,chartData:D})})}))})}):(0,a.jsx)(z,{editorValue:P,handleChange:l=>{let{sql:e,thoughts:i}=lu(l);O(l=>Object.assign({},l,{sql:e,thoughts:i}))},tableData:R,chartData:void 0})]})]})]})}}}]);